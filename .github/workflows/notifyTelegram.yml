name: 'Notify Telegram'

on: 
 workflow_call:
    inputs:
      event_name:
        required: true
        description: 'Name of the GitHub event triggering the notification'
        type: string
      action:
        required: true
        description: 'Specific action that triggered the event'
        type: string
      pr_number:
        required: false
        description: 'Number of the pull request'
        type: string
      pr_title:
        required: false
        description: 'Title of the pull request'
        type: string
      pr_user:
        required: false
        description: 'Username of the user who created the pull request'
        type: string
      pr_url:
        required: false
        description: 'URL of the pull request'
        type: string
      merged:
        required: false
        description: 'Whether the pull request was merged (true/false)'
        type: boolean
      review_state:
        required: false
        description: 'State of the review (e.g., approved, changes requested)'
        type: string
      reviewer_logins:
        required: false
        description: 'Comma-separated list of logins for the reviewers of the pull request'
        type: string
      assignee_logins:
        required: false
        description: 'Comma-separated list of logins for the assignees of the pull request'
        type: string
jobs:
  notification_logic:
    runs-on: ubuntu-latest
    outputs:
      message: ${{ steps.set_message.outputs.message }}
    steps:
      - name: Set Notification Message
        id: set_message
        run: |
          MESSAGE=""
          if [ "${{ inputs.event_name }}" == "pull_request" ] && [ "${{ inputs.action }}" == "opened" ]; then
           MESSAGE+="🆕 *PR #PR${{ inputs.pr_number }}\n opened* by @${{ inputs.pr_user }} - _${{ inputs.pr_title }}_. Check it: [Here](${{ inputs.pr_url }})"
          elif [ "${{ inputs.event_name }}" == "pull_request_review" ] && [ "${{ inputs.review_state }}" == "changes_requested" ]; then
           MESSAGE+="⚠️ *Changes requested*\n on PR #PR${{ inputs.pr_number }} by @${{ inputs.reviewer_logins }}. Review: [Here](${{ inputs.pr_url }})"
          elif [ "${{ inputs.event_name }}" == "pull_request" ] && [ "${{ inputs.action }}" == "synchronize" ]; then
           MESSAGE+="🔄 *PR #PR${{ inputs.pr_number }} updated*\n after changes requested. Review the updates: [Here](${{ inputs.pr_url }})"
          elif [ "${{ inputs.event_name }}" == "pull_request_review" ] && [ "${{ inputs.review_state }}" == "approved" ]; then
           MESSAGE+="✅ *PR #PR${{ inputs.pr_number }} approved*\n by @${{ inputs.reviewer_logins }}. Congratulations! 🎉"
          fi

          echo "MESSAGE=$MESSAGE" >> $GITHUB_ENV

          curl -X POST "https://api.telegram.org/bot6972170862:AAG4aN5Z8ApFusuToNIE8-zEe6PoJLOSl3U/sendMessage" \
               -H "Content-Type: application/x-www-form-urlencoded" \
               -d "chat_id=-1002018935905" \
               -d "text=$MESSAGE" \
               -d "parse_mode=Markdown" \
               -d "disable_web_page_preview=true"
